{# IMPORTANT: Read `instructions/architecture` before making changes. #}
{% extends "base.html" %}

{% block title %}{{ t('docs.page_title') }}{% endblock %}

{% block extra_head %}
<style>
  .docs-layout { display: flex; gap: 18px; }
  .docs-sidebar {
    width: 320px;
    flex: 0 0 320px;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 12px;
    padding: 14px;
  }
  .docs-main {
    flex: 1 1 auto;
    min-width: 0;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 12px;
    padding: 16px;
  }
  .docs-sidebar h2 { margin: 0 0 10px 0; font-size: 18px; }
  .docs-sidebar label { display: block; font-size: 12px; opacity: 0.8; margin-bottom: 6px; }
  .docs-sidebar select { width: 100%; padding: 10px; border-radius: 10px; }
  .files-header { margin-top: 12px; font-size: 12px; opacity: 0.8; }
  #file-list { list-style: none; padding: 0; margin: 10px 0 0 0; max-height: 60vh; overflow: auto; }
  #file-list li { margin: 0; }
  .file-link {
    display: block;
    padding: 8px 10px;
    border-radius: 8px;
    color: inherit;
    text-decoration: none;
    opacity: 0.95;
  }
  .file-link:hover { background: rgba(255,255,255,0.06); }
  .file-link.active { background: rgba(255,255,255,0.10); }
  .muted { opacity: 0.75; }

  /* Minimal markdown styling */
  .markdown-body h1, .markdown-body h2, .markdown-body h3 { margin-top: 18px; }
  .markdown-body pre { overflow: auto; padding: 12px; border-radius: 10px; background: rgba(0,0,0,0.25); }
  .markdown-body code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  .markdown-body table { border-collapse: collapse; width: 100%; overflow: auto; display: block; }
  .markdown-body th, .markdown-body td { border: 1px solid rgba(255,255,255,0.12); padding: 8px; }
</style>
{% endblock %}

{% block content %}
<div style="margin-bottom: 12px;">
  <a href="{{ url_for('welcome.index') }}" style="text-decoration: none;">{{ t('docs.back') }}</a>
</div>

<div class="docs-layout">
  <aside class="docs-sidebar">
    <h2>{{ t('docs.heading') }}</h2>
    <label for="app-select">{{ t('docs.managed_app_label') }}</label>
    <select id="app-select">
      {% for app in apps %}
        <option value="{{ app.id }}" {% if app.id == selected_app_id %}selected{% endif %}>{{ app.name }}</option>
      {% endfor %}
    </select>

    <div class="files-header">{{ t('docs.markdown_files_heading') }}</div>
    <div id="files-empty" class="muted" style="display:none; margin-top: 10px;">{{ t('docs.files_empty') }}</div>
    <ul id="file-list"></ul>
  </aside>

  <main class="docs-main">
    <div id="doc-meta" class="muted" style="margin-bottom: 10px;"></div>
    <article id="doc-content" class="markdown-body">
      <p class="muted">{{ t('docs.select_prompt') }}</p>
    </article>
  </main>
</div>
{% endblock %}

{% block scripts %}
<script>
  const initialAppId = {{ selected_app_id|tojson }};
  const initialPath = {{ selected_path|tojson }};

  const appSelect = document.getElementById('app-select');
  const fileList = document.getElementById('file-list');
  const filesEmpty = document.getElementById('files-empty');
  const docMeta = document.getElementById('doc-meta');
  const docContent = document.getElementById('doc-content');

  function setUrlParams(appId, path) {
    try {
      const u = new URL(window.location.href);
      u.searchParams.set('app_id', appId || '');
      if (path) u.searchParams.set('path', path);
      else u.searchParams.delete('path');
      window.history.replaceState({}, '', u.toString());
    } catch (e) {}
  }

  function setActivePath(path) {
    const links = fileList.querySelectorAll('a.file-link');
    links.forEach(a => {
      if (a.dataset.path === path) a.classList.add('active');
      else a.classList.remove('active');
    });
  }

  async function loadFiles(appId, desiredPath) {
    fileList.innerHTML = '';
    filesEmpty.style.display = 'none';
    docMeta.textContent = '';
    docContent.innerHTML = '<p class="muted">Loading files…</p>';

    const res = await fetch(`/blackgrid/docs/api/files?app_id=${encodeURIComponent(appId)}`);
    const data = await res.json();
    if (!data.success) {
      docContent.innerHTML = `<p class="muted">Error: ${data.error || 'Failed to load files'}</p>`;
      return;
    }

    const files = data.files || [];
    if (!files.length) {
      filesEmpty.style.display = 'block';
      docContent.innerHTML = '<p class="muted">No markdown files found for this app.</p>';
      return;
    }

    files.forEach(path => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = '#';
      a.className = 'file-link';
      a.textContent = path;
      a.dataset.path = path;
      a.addEventListener('click', (e) => {
        e.preventDefault();
        renderDoc(appId, path);
      });
      li.appendChild(a);
      fileList.appendChild(li);
    });

    const toOpen = desiredPath && files.includes(desiredPath) ? desiredPath : files[0];
    renderDoc(appId, toOpen);
  }

  async function renderDoc(appId, path) {
    setActivePath(path);
    setUrlParams(appId, path);
    docMeta.textContent = path;
    docContent.innerHTML = '<p class="muted">Rendering…</p>';

    const res = await fetch(`/blackgrid/docs/api/render?app_id=${encodeURIComponent(appId)}&path=${encodeURIComponent(path)}`);
    const data = await res.json();
    if (!data.success) {
      docContent.innerHTML = `<p class="muted">Error: ${data.error || 'Failed to render'}</p>`;
      return;
    }
    docContent.innerHTML = data.html || '<p class="muted">(empty)</p>';
  }

  appSelect.addEventListener('change', () => {
    const appId = appSelect.value;
    setUrlParams(appId, '');
    loadFiles(appId, '');
  });

  // Initial load
  if (initialAppId) {
    loadFiles(initialAppId, initialPath);
  } else {
    docContent.innerHTML = '<p class="muted">No apps configured.</p>';
  }
</script>
{% endblock %}

